{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% url 'admin:jsi18n' %}"></script>
    {{ media }}
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Alerta de Descarte (Mantido)
            const checkboxDescarte = document.getElementById("id_descartado");
            if (checkboxDescarte) {
                checkboxDescarte.addEventListener('click', function(e) {
                    if (this.checked) {
                        const confirmacao = confirm("ATENÇÃO: Tem certeza que deseja marcar esta encomenda como descartada?\n\nEla desaparecerá das listas principais e só poderá ser vista no filtro 'Lixeira'.");
                        if (!confirmacao) {
                            e.preventDefault();
                            this.checked = false;
                        }
                    }
                });
            }

            // 2. Proteção Contra Duplo Clique e Feedback Visual (Para TODAS as telas)
            // O seletor pega o form dinamicamente baseada no modelo (ex: encomenda_form, user_form, cliente_form)
            const form = document.getElementById("{{ opts.model_name }}_form");
            if (form) {
                form.addEventListener("submit", function(e) {
                    // Seleciona todos os botões de submit da barra inferior
                    const submitButtons = form.querySelectorAll('.submit-row input[type="submit"]');
                    
                    // Se já estiver enviando, bloqueia tudo
                    if (form.dataset.submitting === "true") {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Marca o form como enviando
                    form.dataset.submitting = "true";
                    
                    // Altera visualmente os botões
                    submitButtons.forEach(btn => {
                        btn.style.opacity = "0.6";
                        btn.style.cursor = "wait";
                        btn.value = "Processando...";
                    });
                });
            }
        });
    </script>
{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "admin/css/forms.css" %}">
    
    <style>
        /* ========================
           BOTÃO VOLTAR (TOPO) 
           ======================== */
        .btn-voltar-container {
            margin-bottom: 25px; 
            margin-top: 0;
            padding: 0;
            display: flex;
            justify-content: flex-start;
            margin-left: 0 !important;
        }
        
        .btn-voltar-topo {
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: #6c757d; 
            color: white !important; 
            height: 35px;            
            padding: 0 20px;         
            border-radius: 4px; 
            text-decoration: none; 
            font-weight: 700; 
            font-size: 12px;         
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: Roboto, "Segoe UI", sans-serif;
            transition: background 0.2s;
        }
        .btn-voltar-topo:hover { 
            background: #5a6268; 
            color: white;
        }

        /* ========================
           BARRA DE AÇÕES (INFERIOR)
           ======================== */
        .submit-row {
            padding: 15px 20px; 
            margin: 20px 0; 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        /* CLASSE COMUM "FORCE" PARA TODOS OS BOTÕES */
        .btn-admin-action {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            background: none;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 40px !important;
            padding: 0 25px !important;
            min-width: 120px;
            box-sizing: border-box;
            border-radius: 4px;
            font-family: Roboto, "Segoe UI", sans-serif !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1 !important;
            text-decoration: none !important;
            cursor: pointer;
            transition: background 0.3s;
            margin: 0;
        }

        /* Cores Específicas */

        /* 1. APAGAR (Vermelho) */
        a.deletelink {
            background-color: #C51625 !important; 
            color: white !important;
        }
        a.deletelink:hover {
            background-color: #a71d2a !important;
        }

        /* 2. CANCELAR (Cinza) */
        .btn-cancelar {
            background-color: #6c757d !important; 
            color: white !important;
            margin-right: 10px !important; 
        }
        .btn-cancelar:hover {
            background-color: #5a6268 !important;
        }

        /* 3. SALVAR (Verde) */
        .submit-row input[type=submit].default,
        input[type=submit].default.btn-admin-action {
            background-color: #28a745 !important; 
            color: white !important;
        }
        .submit-row input[type=submit].default:hover,
        input[type=submit].default.btn-admin-action:hover {
            background-color: #218838 !important;
        }
        
        /* Botões secundários de salvar */
        .submit-row input[type=submit]:not(.default),
        input[type=submit]:not(.default).btn-admin-action {
            background: #17a2b8 !important;
            color: white !important;
            margin-right: 10px !important;
        }
    </style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% block content %}

{% if not is_popup %}
<div class="btn-voltar-container">
    <a href="{% url opts|admin_urlname:'changelist' %}" class="btn-voltar-topo">← Voltar para a lista</a>
</div>
{% endif %}

<div id="content-main">
    {% block object-tools %}
    {% if change %}{% if not is_popup %}
      <ul class="object-tools">
        {% block object-tools-items %}
          {% change_form_object_tools %}
        {% endblock %}
      </ul>
    {% endif %}{% endif %}
    {% endblock %}
    
    <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}{% if form_url %}action="{{ form_url }}" {% endif %}method="post" id="{{ opts.model_name }}_form" novalidate>{% csrf_token %}{% block form_top %}{% endblock %}
        <div>
        {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
        {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
        {% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}
        
        {% if errors %}
            <p class="errornote">
            {% if errors|length == 1 %}{% translate "Please correct the error below." %}{% else %}{% translate "Please correct the errors below." %}{% endif %}
            </p>
            {{ adminform.form.non_field_errors }}
        {% endif %}

        {% block field_sets %}
        {% for fieldset in adminform %}
          {% include "admin/includes/fieldset.html" %}
        {% endfor %}
        {% endblock %}

        {% block after_field_sets %}{% endblock %}

        {% block inline_field_sets %}
        {% for inline_admin_formset in inline_admin_formsets %}
            {% include inline_admin_formset.opts.template %}
        {% endfor %}
        {% endblock %}

        {% block after_related_objects %}{% endblock %}

        {% block submit_buttons_bottom %}
        <div class="submit-row">
            
            <div class="submit-left">
                {% if change and has_delete_permission %}
                    {% url opts|admin_urlname:'delete' original.pk|admin_urlquote as delete_url %}
                    <a href="{% add_preserved_filters delete_url %}" class="btn-admin-action deletelink">Apagar {{ opts.verbose_name }}</a>
                {% endif %}
            </div>

            <div class="submit-row-right">
                
                {% if is_popup %}
                    <a href="#" onclick="window.close(); return false;" class="btn-admin-action btn-cancelar">Cancelar</a>
                {% else %}
                    <a href="{% url opts|admin_urlname:'changelist' %}" class="btn-admin-action btn-cancelar">Cancelar</a>
                {% endif %}
                
                {% if show_save_and_add_another %}
                    <input type="submit" value="{% translate 'Save and add another' %}" name="_addanother" class="btn-admin-action">
                {% endif %}
                
                {% if show_save_and_continue %}
                    <input type="submit" value="{% translate 'Save and continue editing' %}" name="_continue" class="btn-admin-action">
                {% endif %}
                
                <input type="submit" value="{% translate 'Save' %}" class="default btn-admin-action" name="_save">
            </div>
        </div>
        {% endblock %}

        {% block admin_change_form_document_ready %}
            <script id="django-admin-form-add-constants" src="{% static 'admin/js/change_form.js' %}"
                {% if adminform and add %}
                    data-model-name="{{ opts.model_name }}"
                {% endif %}
                async>
            </script>
        {% endblock %}

        {# JavaScript for prepopulated fields #}
        {% prepopulated_fields_js %}

        </div>
    </form>
</div>
{% endblock %}