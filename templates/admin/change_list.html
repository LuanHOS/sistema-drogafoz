{% extends "admin/change_list.html" %}
{% load static admin_urls %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* 1. CORREÇÃO VISUAL DAS COLUNAS */
    .field-get_status_fmt {
        min-width: 170px !important;
        width: 170px !important;
        text-align: center;
    }
    
    .field-get_data_chegada_fmt, .field-get_data_saida_fmt {
        white-space: nowrap !important;
        min-width: 110px !important;
    }

    /* 2. CORREÇÃO DO FUNDO AMARELO (SOLICITADO) */
    /* Remove a cor amarela padrão do Django quando uma linha está selecionada */
    #changelist-form .results table tbody tr.selected {
        background-color: inherit !important;
        color: inherit !important;
    }
    /* Mantém o hover cinza claro padrão para não perder usabilidade */
    #changelist-form .results table tbody tr:hover {
        background-color: #f8f9fa !important;
    }

    /* 3. BOTÃO VOLTAR */
    .btn-voltar-container {
        margin-bottom: 20px;
    }
    
    .btn-voltar-topo {
        text-decoration: none;
        color: #666;
        font-weight: bold;
        font-size: 13px;
        text-transform: uppercase;
    }
    .btn-voltar-topo:hover {
        color: #333;
    }

    /* 4. CONTADOR E BOTÃO LIMPAR (X) */
    .selection-counter-container {
        margin-left: 10px;
        display: inline-flex;
        align-items: center;
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        border: 1px solid #ced4da;
    }

    .selection-counter-text {
        font-size: 12px;
        color: #123C65;
        font-weight: bold;
        margin-right: 6px;
    }

    .btn-limpar-x {
        background: none;
        border: none;
        color: #C51625; /* Vermelho */
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        display: flex;
        align-items: center;
    }
    .btn-limpar-x:hover {
        color: #a71d2a;
        transform: scale(1.1);
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<div class="btn-voltar-container">
    <a href="{% url 'admin:index' %}" class="btn-voltar-topo" id="btn-voltar-home">← Voltar ao Início</a>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const isEncomendaList = document.body.classList.contains('model-encomenda');
        const form = document.getElementById('changelist-form');
        
        // Chaves de Memória
        const STORAGE_KEY = 'drogafoz_encomenda_selection'; 
        const KEEP_KEY = 'drogafoz_keep_selection'; // Bandeira de segurança

        // --- 1. RESPONSIVIDADE DO BOTÃO DE AÇÃO (MOBILE) ---
        function optimizeActionText() {
            const isMobile = window.innerWidth < 768; 
            const select = document.querySelector('select[name="action"]');
            
            if (!select) return;
            
            for (let i = 0; i < select.options.length; i++) {
                const opt = select.options[i];
                if (opt.value === 'marcar_entregue') {
                    if (!opt.dataset.originalText) {
                        opt.dataset.originalText = opt.text;
                    }
                    if (isMobile) {
                        opt.text = "✅ Baixa (Entregue)";
                    } else {
                        opt.text = opt.dataset.originalText;
                    }
                }
            }
        }
        window.addEventListener('resize', optimizeActionText);
        optimizeActionText();

        // SE NÃO FOR ENCOMENDA, SAI DAQUI
        if (!isEncomendaList || !form) return;


        // --- 2. LÓGICA DE LIMPEZA INTELIGENTE ---
        // Verifica se a "bandeira de segurança" existe. 
        // Se NÃO existir, significa que viemos de um Refresh, Voltar, ou Adicionar. Limpa tudo.
        if (!sessionStorage.getItem(KEEP_KEY)) {
            sessionStorage.removeItem(STORAGE_KEY);
        } else {
            // Se existir, consome a bandeira (apaga) para que o próximo refresh limpe.
            sessionStorage.removeItem(KEEP_KEY);
        }

        // Função para ativar a bandeira (usada apenas em ações seguras)
        function setKeepFlag() {
            sessionStorage.setItem(KEEP_KEY, 'true');
        }

        // --- 3. LISTENERS PARA MANTER A SELEÇÃO (Apenas Filtros/Busca) ---
        
        // A. Pesquisa (Botão Search)
        const searchForm = document.getElementById('changelist-search');
        if (searchForm) {
            searchForm.addEventListener('submit', setKeepFlag);
        }

        // B. Cliques em Links Seguros (Filtros, Paginação, Ordenação)
        document.addEventListener('click', function(e) {
            const target = e.target.closest('a');
            if (!target) return;

            // Se for link de Filtro lateral
            if (target.closest('#changelist-filter')) {
                setKeepFlag();
                return;
            }
            
            // Se for Paginação (1, 2, Próximo...)
            if (target.closest('.paginator')) {
                setKeepFlag();
                return;
            }

            // Se for Ordenação de Coluna (Header da tabela)
            if (target.closest('.result-headers')) {
                setKeepFlag();
                return;
            }
            
            // Se clicar em "Adicionar Encomenda" ou "Voltar", NÃO chama setKeepFlag(),
            // logo a seleção será limpa no próximo carregamento.
        });


        // --- 4. GERENCIAMENTO DA SELEÇÃO (IDs) ---

        function getSavedIds() {
            const saved = sessionStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        function saveId(id) {
            let ids = getSavedIds();
            if (!ids.includes(id)) {
                ids.push(id);
                sessionStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
            }
            updateCounterUI();
        }

        function removeId(id) {
            let ids = getSavedIds();
            ids = ids.filter(item => item !== id);
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
            updateCounterUI();
        }

        function clearStorage() {
            sessionStorage.removeItem(STORAGE_KEY);
            // Desmarca visualmente na hora
            form.querySelectorAll('input.action-select').forEach(cb => cb.checked = false);
            updateCounterUI();
        }

        // Atualiza a interface (Contador + Botão X)
        function updateCounterUI() {
            const ids = getSavedIds();
            let container = document.getElementById('selection-counter-container');
            
            // Se não tem nada selecionado, remove o container visual e retorna
            if (ids.length === 0) {
                if (container) container.remove();
                return;
            }

            // Se tem seleção mas não tem container, cria ele
            if (!container) {
                const actionsDiv = document.querySelector('.actions');
                if (actionsDiv) {
                    container = document.createElement('span');
                    container.id = 'selection-counter-container';
                    container.className = 'selection-counter-container';
                    actionsDiv.appendChild(container);
                } else {
                    return;
                }
            }

            // Atualiza conteúdo
            container.innerHTML = `
                <span class="selection-counter-text">(${ids.length} selecionados)</span>
                <button type="button" id="btn-limpar-x" class="btn-limpar-x" title="Limpar seleção">✖</button>
            `;
            
            // Re-anexa o evento do botão X
            document.getElementById('btn-limpar-x').onclick = function(e) {
                e.preventDefault();
                clearStorage();
            };
        }

        // --- 5. SINCRONIZAÇÃO AO CARREGAR ---
        const savedIds = getSavedIds();
        const checkboxes = form.querySelectorAll('input.action-select');
        
        checkboxes.forEach(cb => {
            if (savedIds.includes(cb.value)) {
                cb.checked = true;
                // Força a linha a não ficar amarela (garantia extra via JS além do CSS)
                const row = cb.closest('tr');
                if(row) row.classList.add('selected-persistent'); // Classe fictícia só pra controle se precisar
            }

            cb.addEventListener('change', function() {
                if (this.checked) {
                    saveId(this.value);
                } else {
                    removeId(this.value);
                }
            });
        });

        // --- 6. ENVIO DO FORMULÁRIO (BOTÃO IR) ---
        form.addEventListener('submit', function(e) {
            const allSavedIds = getSavedIds();
            if (allSavedIds.length === 0) return;

            const visibleInputs = Array.from(form.querySelectorAll('input.action-select'));
            const visibleIds = visibleInputs.map(input => input.value);
            
            // Injeta apenas os IDs que NÃO estão na tela (os da tela o Django já manda)
            const hiddenIdsToAdd = allSavedIds.filter(id => !visibleIds.includes(id));

            hiddenIdsToAdd.forEach(id => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = '_selected_action';
                hiddenInput.value = id;
                form.appendChild(hiddenInput);
            });

            // Limpa a memória pois a ação foi executada (vai mudar de página para a confirmação)
            sessionStorage.removeItem(STORAGE_KEY);
        });

        // Inicializa UI
        updateCounterUI();
    });
</script>
{% endblock %}