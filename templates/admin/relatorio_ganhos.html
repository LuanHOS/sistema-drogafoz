{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container { font-family: 'Segoe UI', sans-serif; }
        
        /* FILTRO */
        .filter-bar { background: #fff; padding: 15px 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #123C65; }
        .filter-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
        .form-control { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-filtrar { background: #123C65; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
        
        /* SE√á√ïES */
        .section-header { margin-top: 30px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .section-header h2 { margin: 0; font-size: 18px; color: #333; font-weight: 600; }
        .section-header small { color: #888; font-weight: normal; font-size: 13px; margin-left: 10px; }

        /* GRID CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 12px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-card .sub { font-size: 12px; color: #666; }

        /* CORES */
        .border-green { border-bottom: 3px solid #28a745; }
        .text-green { color: #28a745 !important; }
        .border-red { border-bottom: 3px solid #dc3545; }
        .text-red { color: #dc3545 !important; }
        .border-blue { border-bottom: 3px solid #17a2b8; }
        .text-blue { color: #17a2b8 !important; }
        .border-orange { border-bottom: 3px solid #fd7e14; }
        .text-orange { color: #fd7e14 !important; }

        /* TABELAS E GR√ÅFICOS */
        .content-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        
        .panel { 
            background: #fff; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); min-width: 0; 
        }
        .panel h4 { margin-top: 0; color: #444; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

        .mini-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .mini-table th { text-align: left; color: #888; padding: 8px 0; border-bottom: 1px solid #eee; }
        .mini-table td { padding: 10px 0; border-bottom: 1px solid #f9f9f9; color: #333; }
        
        .badge-alert { background: #ffeeba; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-crit { background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        /* CHART WRAPPER */
        .chart-container-box { position: relative; height: 300px; width: 100%; overflow: hidden; }

        @media (max-width: 768px) { .content-row { grid-template-columns: 1fr; } }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="btn-voltar-container" style="margin: 0 !important; padding: 0 !important;">
            <a href="{% url 'admin:index' %}" class="btn-voltar-topo">‚Üê Voltar ao In√≠cio</a>
        </div>
        <span style="font-size: 12px; color: #888;">√öltima atualiza√ß√£o: {% now "d/m/Y H:i" %}</span>
    </div>

    <div class="filter-bar">
        <form method="get" class="filter-form">
            <div class="form-group">
                <label>In√≠cio</label>
                <input type="date" name="data_inicial" value="{{ data_inicial }}" class="form-control" id="dt_ini" {% if ignorar_periodo %}disabled{% endif %}>
            </div>
            <div class="form-group">
                <label>Fim</label>
                <input type="date" name="data_final" value="{{ data_final }}" class="form-control" id="dt_fim" {% if ignorar_periodo %}disabled{% endif %}>
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
                <input type="checkbox" name="ignorar_periodo" id="chk_ignorar" {% if ignorar_periodo %}checked{% endif %} onchange="toggleDates()">
                <label for="chk_ignorar" style="cursor: pointer; margin: 0; color: #333;">Ver Todo Hist√≥rico</label>
            </div>
            <div class="form-group">
                <button type="submit" class="btn-filtrar">Atualizar</button>
            </div>
        </form>
    </div>

    <div class="section-header">
        <h2>üí∞ Financeiro e Performance <small>({{ periodo_label }})</small></h2>
    </div>
    <div class="stats-grid">
        <div class="stat-card border-green">
            <h3>Faturamento Real</h3>
            <div class="value text-green">R$ {{ faturamento_real|floatformat:2 }}</div>
            <div class="sub">{{ qtd_entregues }} encomendas baixadas</div>
        </div>
        <div class="stat-card border-orange">
            <h3>Descontos Concedidos</h3>
            <div class="value text-red">R$ {{ descontos_dados|floatformat:2 }}</div>
            <div class="sub">Diferen√ßa entre o calculado e o cobrado</div>
        </div>
        <div class="stat-card border-blue">
            <h3>Ticket M√©dio</h3>
            <div class="value text-black">R$ {{ ticket_medio|floatformat:2 }}</div>
            <div class="sub">M√©dia por cliente</div>
        </div>
        
        <div class="stat-card border-blue">
            <h3>Chegadas no Per√≠odo</h3>
            <div class="value text-green">{{ qtd_chegadas }}</div>
            <div class="sub">Chegaram no intervalo definido</div>
        </div>

        <div class="stat-card border-green">
            <h3>Sa√≠das no Per√≠odo</h3>
            <div class="value text-red">{{ qtd_entregues }}</div>
            <div class="sub">Entregues no intervalo definido</div>
        </div>
    </div>

    <div class="content-row">
        <div class="panel">
            <h4>üìà Evolu√ß√£o do Faturamento (√öltimos 6 Meses)</h4>
            <div class="chart-container-box">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h4>üèÜ Top 5 Clientes (Per√≠odo)</h4>
            <table class="mini-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th style="text-align: right;">Gasto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in top_clientes %}
                    <tr>
                        <td>{{ c.cliente__nome }} <br> <small style="color:#999">{{ c.qtd }} retiradas</small></td>
                        <td style="text-align: right; font-weight: bold;">R$ {{ c.total_gasto|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" style="text-align: center;">Sem dados no per√≠odo</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-header" style="margin-top: 40px;">
        <h2>üì¶ Raio-X do Estoque e Auditoria <small>(Status Atual)</small></h2>
    </div>
    <div class="stats-grid">
        <div class="stat-card border-blue">
            <h3>Ocupa√ß√£o Atual</h3>
            <div class="value">{{ estoque_qtd }}</div>
            <div class="sub">Caixas nas prateleiras hoje</div>
        </div>
        <div class="stat-card border-green">
            <h3>Potencial (Base)</h3>
            <div class="value">R$ {{ estoque_valor_base|floatformat:2 }}</div>
            <div class="sub">Valor m√≠nimo acumulado</div>
        </div>
        
        <div class="stat-card">
            <h3>Tempo M√©dio (Geral)</h3>
            <div class="value">{{ tempo_medio_dias }} Dias</div>
            <div class="sub">M√©dia hist√≥rica desde o in√≠cio</div>
        </div>

        <div class="stat-card border-red">
            <h3>Alertas de Prazo</h3>
            <div class="value text-red">{{ alertas_criticos }}</div>
            <div class="sub">
                <span class="badge-crit">Cr√≠ticos (+120d)</span> 
                <span class="badge-alert">{{ alertas_atencao }} Aten√ß√£o (+30d)</span>
            </div>
        </div>
    </div>

</div>

<script>
    function toggleDates() {
        var chk = document.getElementById('chk_ignorar');
        document.getElementById('dt_ini').disabled = chk.checked;
        document.getElementById('dt_fim').disabled = chk.checked;
    }

    document.addEventListener("DOMContentLoaded", function() {
        toggleDates();

        const ctx = document.getElementById('revenueChart').getContext('2d');
        const labels = JSON.parse('{{ grafico_labels|safe }}');
        const data = JSON.parse('{{ grafico_dados|safe }}');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Faturamento (R$)',
                    data: data,
                    backgroundColor: 'rgba(18, 60, 101, 0.7)',
                    borderColor: 'rgba(18, 60, 101, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    });
</script>
{% endblock %}